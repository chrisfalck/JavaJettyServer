<!DOCTYPE html>
<html lang="en-US">

<!-- Angular Material icons -->
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">

<!-- Angular Material requires Angular.js Libraries -->
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>

<!-- Angular Material Library -->
<script src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>

<!-- Styles -->

<head>
    <title>
        Seattle Crime Analysis
    </title>
    <style type="text/css">
        .center {
            text-align: center;
        }

        .area1,
        .area2 {
            display: flex;
            box-sizing: border-box;
            min-width: 100%;
        }

        .area1 {
            height: 10%;
            max-height: 10%;
            width: 100%;
            min-width: 100%;
            flex: 1 1 10%;
            border: 1px darkblue;
            border-style: none none solid none;
        }

        .area2 {
            height: 90%;
            max-height: 90%;
            width: 100%;
            min-width: 100%;
            flex: 1 1 100%;
        }

        .left {
            text-align: left;
            margin: 2px 10px;
            display: inline;
        }

        .right {
            text-align: right;
            margin: 2px 10px;
            display: inline;
        }

        .margin-left {
            margin-left: 50px;
        }

        .data {
            margin-top: 100px;
            margin-left: 50px;
        }

        .table-data td {
            text-align: center;
        }
    </style>
</head>

<body ng-app="databasesApp" ng-controller="IndexController" ng-cloak layout="column" ng-init="initializePage()">

    <!-- Visible page content -->
    <md-toolbar layout="row" layout-align="center center">
        <h3 class="center">Intro to Databases Fall 2016: Seattle Crime Database Analysis</h3>
    </md-toolbar>

    <div flex layout="row">
        <div layout="column" flex>
            <div class="area1">
                <!-- Make sure to wrap normal content in an md-content tag! -->
                <md-content class="margin-left">
                    <br>
                    <span>Analyze data by:</span>
                    <select ng-options="viewType for viewType in viewOptions" ng-model="selectedView" ng-change="applyViewChange()">
					</select>
                </md-content>
            </div>
            <div class="area2">

                <!-- View crime statistics by frequency view. -->
                <div ng-show="selectedView === 'Frequency'" style="width: 60%;">
                    <md-button class="md-raised md-primary" ng-click="applyChanges()">Apply Changes</md-button>
                    <md-content class="margin-left" style="width: 1000px; overflow: visible;">
                        <h3>Select Sorting Options</h3>
                        <div style="border-style: solid; border-width: 1px; border-color: lightgrey; padding: 5px;">
                            <form>
                                From:
                                <input id="frequencyFromDate" type="date" ng-model="frequencyView.fromDate"> To:
                                <input id="frequencyToDate" type="date" ng-model="frequencyView.toDate">
                            </form>
                            <hr>
                            <span>Filter by Event Clearance Group:</span>
                            <select ng-options="eventGroup as eventGroup.name for eventGroup in eventClearanceGroupList" ng-model="selectedClearanceGroup"></select>
                            <br>
                            <hr>
                            <span>Filter by Block Address:</span>
                            <select ng-options="location as location.addr for location in blockAddressList" ng-model="selectedBlockAddress"></select>
                            <br>
                            <br>
                            <span>There are {{upperAdressHardBoundary}} unique addresses in the database. Select a subset of them to filter by.</span>
                            <br>
                            <span>Range:<input ng-model="addressLowerBound"/> to <input ng-model="addressUpperBound"/><button ng-click="updateAddressList()">Update Address List</button></span>
                            <hr>
                            <md-radio-group ng-model="frequencyView.sortOrder" class="left">
                                <md-radio-button value="desc">Most Frequent First</md-radio-button>
                                <md-radio-button value="asc">Least Frequent First</md-radio-button>
                            </md-radio-group>
                        </div>
                        <div ng-show="frequencyData.length > 0">
                            <table border="1" style="text-align: center; width: 100%">
                                <thead>
                                    <tr>
                                        <th>Event Clearance Code</th>
                                        <th>Event Clearance Description</th>
                                        <th>Number of Incidents of This Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="entry in frequencyData" class="table-data">
                                        <td>{{entry.event_code[0]}}</td>
                                        <td>{{entry.event_clearance_description[0]}}</td>
                                        <td>{{entry.num[0]}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </md-content>
                </div>

                <!-- View crime statistics for a specific crime. -->
                <div ng-show="selectedView === 'Specific Crime'">
                    <md-button class="md-raised md-primary" ng-click="applyChanges()">Apply Changes</md-button>
                    <md-content class="margin-left" style="width: 1000px; overflow: visible;">
                        <h3>Select Date Range</h3>
                        <div class="margin-left">
                            <form class="right">
                                From:
                                <input type="date" ng-model="specificView.fromDate"> To:
                                <input type="date" ng-model="specificView.toDate">
                            </form>
                        </div>
                        <div class="data" ng-show="specificData.length > 0">
                            <table border="1">
                                <thead>
                                    <tr>
                                        <th>General Offense Number</th>
                                        <th>Event Code</th>
                                        <th>Address</th>
                                        <th>Date</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="entry in specificData" class="table-data">
                                        <td>{{entry.general_offense_number[0]}}</td>
                                        <td>{{entry.event_code[0]}}</td>
                                        <td>{{entry.addr[0]}}</td>
                                        <td>{{entry.crime_date[0]}}</td>
                                        <td>{{entry.time[0]}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </md-content>
                </div>

            </div>
        </div>
    </div>







    <!-- Angular controller setup. -->
    <script>
		var app = angular.module('databasesApp', ['ngMaterial']);
		app.controller('IndexController', ['$scope', '$http', function($scope, $http) {

            let currentUrl = window.location.href;
            let ip, port, serverBaseUrl;

            if (currentUrl.indexOf('localhost') === -1) {
                ip = currentUrl.split('//')[1].split(':')[0];
                port = currentUrl.split('//')[1].split(':')[1].split('/')[0];
                serverBaseUrl = 'http://' + ip + ':' + port + '/?password=' + getParameterByName('password');
            }
            else {
                serverBaseUrl = 'http://localhost:9090/?password=' + getParameterByName('password');
            }

            let generalQueryUrl = serverBaseUrl + '&databaseQuery=generalQuery';


			// The two types of views we offer.
			$scope.viewOptions = ['Frequency', 'Specific Crime'];

			// Default the view to frequency on initial page load.
			$scope.selectedView = $scope.viewOptions[0];

            // Call everything needed to initialize the app.
            $scope.initializePage = function() {
                initializeDates(chainGroupListInit);

                function chainGroupListInit() {
                    initializeEventClearanceGroupList(chainBlockAddressInit);
                };

                function chainBlockAddressInit() {
                    initializeBlockAddressList(chainBlockAddressRangeInit);
                };

                function chainBlockAddressRangeInit() {
                    initializeBlockAddressRange();
                };
            };

            function initializeBlockAddressRange() {
                let addressRangeRequestBody = {
                    'query': 'select count(address) as addressRange from Location',
                    'returnValues': {
                        'addressRange': 'int'
                    }
                };

                $http.post(generalQueryUrl, addressRangeRequestBody).then(
                    (successResponse) => {
                        $scope.upperAdressHardBoundary = successResponse.data[0].addressRange[0];
                    },
                    (errorResponse) => {
                        console.log(errorResponse);
                    }
                );
            };

            function initializeDates(callback) {

                let fromDateElementModels = ['frequencyView', 'specificView'];
                let toDateElementModels = ['frequencyView', 'specificView'];

                let minDateRequestBody = {
                    'query': 'select min(crime_date) as fromDate from CrimeTime',
                    'returnValues' : {
                        'fromDate' : 'string'
                    }
                }

                let maxDateRequestBody = {
                    'query': 'select max(crime_date) as toDate from CrimeTime',
                    'returnValues' : {
                        'toDate' : 'string'
                    }
                }

                $http.post(generalQueryUrl, minDateRequestBody).then(
                    (successResponse) => {
                        fromDateElementModels.forEach((dateModel) => {
                            let defaultFromDate = new Date(successResponse.data[0].fromDate[0]);
                            $scope[dateModel].fromDate = defaultFromDate;
                        });
                        getMaxDate();
                    },
                    (errorResponse) => {
                        console.log('Error: ' + JSON.stringify(errorResponse));
                    }
                );

                function getMaxDate() {

                     $http.post(generalQueryUrl, maxDateRequestBody).then(
                        (successResponse) => {
                            toDateElementModels.forEach((dateModel) => {
                                let defaultToDate = new Date(successResponse.data[0].toDate[0]);
                                $scope[dateModel].toDate = defaultToDate;
                            });
                            callback();
                        },
                        (errorResponse) => {
                            console.log(errorResponse);
                        }
                    );

                };

            };

            function initializeEventClearanceGroupList(callback) {
                let eventClearanceGroupRequestBody = {
                    'query': 'select distinct name from Event_Clearance_Group',
                    'returnValues': {
                        'name' : 'string'
                    }
                };

                $http.post(generalQueryUrl, eventClearanceGroupRequestBody).then(
                    (successResponse) => {
                        console.log(successResponse);
                        $scope.eventClearanceGroupList = successResponse.data;
                        $scope.eventClearanceGroupList.unshift({'name': '-No filter-'});
                        if (callback) callback();
                    },
                    (errorResponse) => {
                        console.log(JSON.stringify(errorResponse));
                    }
                );
            };

            $scope.addressLowerBound = 0;
            $scope.addressUpperBound = 1000;
            function initializeBlockAddressList(callback) {
                let clearanceGroupFilter;
                let blockAddressFilter;

                // This will be true if the field exists and is not the string '-No filter-'.
                // typeOf returns 'object' if the selection is valid for the query.
                if ($scope.selectedClearanceGroup && typeof($scope.selectedClearanceGroup.name) !== 'string') clearanceGroupFilter = ' and group_name=\'' + $scope.selectedClearanceGroup.name[0] + '\' ';
                else clearanceGroupFilter = '';

                if ($scope.selectedBlockAddress && typeof($scope.selectedBlockAddress.addr) !== 'string') blockAddressFilter = ' and addr=\'' + $scope.selectedBlockAddress.addr[0] + '\' ';
                else blockAddressFilter = '';

                let query = '' +
                    'select * from\n' +
                    '(\n' +
                        '\tselect t.*, rownum as rn from\n' +
                        '\t(\n' +
                            '\t\tselect distinct addr, count(addr) as num\n' +
                            '\t\tfrom Incident, Type, CrimeTime\n' +
                            '\t\twhere event_code = event_clearance_code and general_offense_number = offense_number and addr != \'NULL\'\n' +
                                '\t\t\tand crime_date > To_Date(\'' + $scope.frequencyView.fromDate.toISOString().split('T')[0] + '\', \'YYYY-MM-DD\')\n' +
                                '\t\t\tand crime_date < To_Date(\'' + $scope.frequencyView.toDate.toISOString().split('T')[0] + '\',\'YYYY-MM-DD\')\n' +
                                '\t\t\t' + clearanceGroupFilter + blockAddressFilter +
                            '\t\tgroup by addr order by count(addr) desc\n' +
                        '\t) t\n' +
                    ')\n' +
                    'where rn < ' + $scope.addressUpperBound + ' and rn > ' + $scope.addressLowerBound;

                let blockAddressRequestBody = {
                    'query': query,
                    'returnValues': {
                        'addr': 'string'
                    }
                }

                $http.post(generalQueryUrl, blockAddressRequestBody).then(
                    (successResponse) => {
                        console.log(successResponse);
                        $scope.blockAddressList = successResponse.data;
                        $scope.blockAddressList.unshift({'addr': '-No filter-'});
                        if (callback) callback();
                    },
                    (errorResponse) => {
                        console.log(errorResponse);
                    }
                );
            };

            // Values for the state of the frequency view.
			$scope.frequencyView = {
				sortOrder: 'desc',
				fromDate: null,
				toDate: null,
                eventClearanceGroup: null,
				location: null
			};

			// Values for the state of the specific view.
			$scope.specificView = {
				fromDate: null,
				toDate: null,
				location: null
			};

            $scope.data = [];

			function validateQueryOptions() {
				if ($scope.selectedView === $scope.viewOptions[0]) {
					if ($scope.frequencyView.sortOrder !== 'asc' && $scope.frequencyView.sortOrder !== 'desc') {
						return false;
					}
					if ($scope.frequencyView.fromDate === null  || $scope.frequencyView.toDate === null) {
						return false;
					}
					return true;
				}
                else if($scope.selectedView === $scope.viewOptions[1]) {
					if($scope.specificView.fromDate === null || $scope.specificView.toDate === null) {
						return false;
					}
					return true;
				}
			};

			function getParameterByName(name, url) {
				if (!url) {
					url = window.location.href;
				}
				name = name.replace(/[\[\]]/g, "\\$&");
				var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
				if (!results) return null;
				if (!results[2]) return '';
				return decodeURIComponent(results[2].replace(/\+/g, " "));
			};

			$scope.applyChanges = function() {

				// Validate all fields.
				if (!validateQueryOptions()) {
					alert('Query options are invalid.');
					return;
				}

                if ($scope.selectedView === $scope.viewOptions[0]) updateFrequencyView();
                if ($scope.selectedView === $scope.viewOptions[1]) updateSpecificCrimeView();

			};

            $scope.updateAddressList = function() {
                if (!$scope.addressLowerBound || $scope.addressLowerBound < 0 || $scope.addressLowerBound >= $scope.addressUpperBound) $scope.addressLowerBound = 0;
                if (!$scope.addressUpperBound || $scope.addressUpperBound < $scope.addressLowerBound || $scope.addressUpperBound > $scope.upperAdressHardBoundary) $scope.addressUpperBound = $scope.addressLowerBound + 1;

                initializeBlockAddressList();
            }

            function updateFrequencyView() {
                let clearanceGroupFilter;
                let blockAddressFilter;

                // This will be true if the field exists and is not the string '-No filter-'.
                // typeOf returns 'object' if the selection is valid for the query.
                if ($scope.selectedClearanceGroup && typeof($scope.selectedClearanceGroup.name) !== 'string') clearanceGroupFilter = ' and group_name=\'' + $scope.selectedClearanceGroup.name[0] + '\' ';
                else clearanceGroupFilter = '';

                if ($scope.selectedBlockAddress && typeof($scope.selectedBlockAddress.addr) !== 'string') blockAddressFilter = ' and addr=\'' + $scope.selectedBlockAddress.addr[0] + '\' ';
                else blockAddressFilter = '';

                let query = '' +
                'select event_code, event_clearance_description, count(event_code) as num\n' +
                'from Incident, Type, CrimeTime\n' +
                'where event_code = event_clearance_code and general_offense_number = offense_number\n' +
                      'and crime_date > To_Date(\'' + $scope.frequencyView.fromDate.toISOString().split('T')[0] + '\', \'YYYY-MM-DD\')\n' +
                      'and crime_date < To_Date(\'' + $scope.frequencyView.toDate.toISOString().split('T')[0] + '\',\'YYYY-MM-DD\')\n' +
                       clearanceGroupFilter + blockAddressFilter +
                'group by event_code, event_clearance_description order by count(event_code) ' + $scope.frequencyView.sortOrder;

                let updateFrequencyViewRequestBody = {
                    'query': query,
                    'returnValues' : {
                        'event_code': 'string',
                        'event_clearance_description': 'string',
                        'num': 'int'
                    }
                }

                $http.post(generalQueryUrl, updateFrequencyViewRequestBody).then(
                    (successResponse) => {
                        $scope.frequencyData = successResponse.data;
                    },
                    (errorResponse) => {
                        console.log(errorResponse);
                    }
                );

            };

            function updateSpecificCrimeView() {
                let query = '' +
                'select * from Incident, CrimeTime ' +
                'where general_offense_number = offense_number ' +
                      'and crime_date > To_Date(\'' + $scope.specificView.fromDate.toISOString().split('T')[0] + '\', \'YYYY-MM-DD\') ' +
                      'and crime_date < To_Date(\'' + $scope.specificView.toDate.toISOString().split('T')[0] + '\',\'YYYY-MM-DD\') ' +
                      'and rownum < 1000';

                let specificCrimeRequestBody = {
                    'query': query,
                    'returnValues': {
                        'general_offense_number': 'string',
                        'event_code': 'int',
                        'addr': 'string',
                        'crime_date': 'date',
                        'time': 'string'
                    }
                }

                $http.post(generalQueryUrl, specificCrimeRequestBody).then(
                    (successResponse) => {
                        console.log(successResponse);
                        $scope.specificData = successResponse.data;
                    },
                    (errorResponse) => {
                        console.log(errorResponse);
                    }
                );
            };

		}]);
	</script>

</body>

</html>
